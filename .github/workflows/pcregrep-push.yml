name: PCREGREP-PUSH

on:
  push:
    branches:
      - '*'
      - '*/*'
    tags-ignore:
      - '*'


jobs:
  pcregrep:
    name: pcregrep Chinese
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: install pcregrep
        run: |
          sudo apt-get update
          sudo apt-get install pcregrep

      - name: gen pcregrep
        run: |
          pcregrep --exclude-dir=mtr -r -n -I '[^\x00-\x7f]' . > pcregrep.out

      - name: pcregrep Chinese
        run: |
          SHA=${{ github.sha }}
          
          git fetch
          git checkout origin/main
          MAIN_SHA=`git rev-parse HEAD`
          
          git reset --hard $SHA
          
          FILE_PATH=`git diff --name-only $SHA $MAIN_SHA`
          
          python ${{ github.workspace }}/.github/workflows/pcregrep.py \
            --source="${{ github.workspace }}/pcregrep.out" \
            --filter="$FILE_PATH"
