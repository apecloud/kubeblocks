name: RELEASE-IMAGE

on:
  schedule:
    - cron: '0 0 * * 1-5' # Runs at 00:00 UTC on Mon to Friday
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'image tag'
        required: false
        default: 'latest'
  release:
    types:
      - published

env:
  GO_VERSION: '1.19'
  DOCKER_REGISTRY_URL: docker.io
  ALIYUN_REGISTRY_URL: registry.cn-hangzhou.aliyuncs.com
  RELEASE_VERSION: ${{ github.ref_name }}


jobs:
  release-image:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check out code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: make generate
        run: make generate

      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2
        with:
          driver-opts: image=moby/buildkit:master

      - name: make push-manager-image
        run: |
          RELEASE_VERSION="latest"
          if [[ ! -z "${{ github.event.inputs.image_tag }}" ]]; then
            RELEASE_VERSION="${{ github.event.inputs.image_tag }}"
          elif [[ "${{ env.RELEASE_VERSION }}" == "main" ]]; then
            RELEASE_VERSION="latest"
          elif [[ ! -z "${{ env.RELEASE_VERSION }}" ]]; then
            RELEASE_VERSION=`bash ${{ github.workspace }}/.github/utils/utils.sh \
              --tag-name ${{ env.RELEASE_VERSION }} \
              --type 1`
          fi
          
          docker login --username ${{ secrets.DOCKER_REGISTRY_USER }} \
            --password ${{ secrets.DOCKER_REGISTRY_PASSWORD }} ${{ env.DOCKER_REGISTRY_URL }}
          
          BUILDX_ARGS="--sbom=false --provenance=false" BUILDX_ENABLED=true VERSION=$RELEASE_VERSION make push-manager-image
          
          docker login --username ${{ secrets.ALIYUN_REGISTRY_USER }} \
            --password ${{ secrets.ALIYUN_REGISTRY_PASSWORD }} ${{ env.ALIYUN_REGISTRY_URL }}
          
          BUILDX_ENABLED=true VERSION=$RELEASE_VERSION BUILDX_ARGS="--sbom=false --provenance=false" \
            IMG=${{ env.ALIYUN_REGISTRY_URL }}/apecloud/kubeblocks \
            make push-manager-image
