name: RELEASE-IMAGE

on:
  release:
    types:
      - published

env:
  GO_VERSION: '1.18'
  DOCKER_REGISTRY_URL: docker.io
  RELEASE_VERSION: ${{ github.ref_name }}


jobs:
  release-image:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check out code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: make generate
        run: make generate

      - uses: docker/setup-qemu-action@v1
      - uses: docker/setup-buildx-action@v1
        with:
          driver-opts: image=moby/buildkit:master

      - name: make push-manager-image
        run: |
          docker login --username ${{ secrets.DOCKER_REGISTRY_USER }} \
            --password ${{ secrets.DOCKER_REGISTRY_PASSWORD }} ${{ env.DOCKER_REGISTRY_URL }}
          
          RELEASE_VERSION=`bash ${{ github.workspace }}/.github/utils/utils.sh ${{ env.RELEASE_VERSION }} 1`
          
          BUILDX_ENABLED=true VERSION=$RELEASE_VERSION make push-manager-image