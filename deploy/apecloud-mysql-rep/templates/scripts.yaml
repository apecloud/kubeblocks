apiVersion: v1
kind: ConfigMap
metadata:
  name: apecloud-mysql-rep-scripts
data:
  init.sh: |
    #!/bin/sh
    set -ex
    echo [mysqld] > /etc/mysql/conf.d/server-id.cnf
    [[ $KB_POD_NAME =~ -([0-9]+)-([0-9]+)$ ]] || exit 1
    ordinal=${BASH_REMATCH[1]}
    echo server-id=$((100 + $ordinal)) >> /etc/mysql/conf.d/server-id.cnf
    PRIMARY_ROLE=primary
    KB_ROLE_NAME=`cat /opt/conf/role/labels`
    if [ $KB_ROLE_NAME = "$PRIMARY_ROLE" ]; then
      cp /opt/mnt/primary/mysql.cnf /etc/mysql/conf.d
    else
      cp /opt/mnt/secondary/mysql.cnf /etc/mysql/conf.d
    fi
  post_start.sh: |
    #!/bin/sh
    set -ex
    SECONDARY_ROLE=secondary
    KB_ROLE_NAME=`cat /opt/conf/role/labels`
    if [ $KB_ROLE_NAME = "$SECONDARY_ROLE" ]; then
      until mysql -hlocalhost -u$MYSQL_ROOT_USER -p$MYSQL_ROOT_PASSWORD -e "SELECT 1;"; do sleep 1; done
      echo "Setting the secondary configuration"
      mysql -hlocalhost -u$MYSQL_ROOT_USER -p$MYSQL_ROOT_PASSWORD -e "CHANGE REPLICATION SOURCE TO SOURCE_HOST='$KB_PRIMARY_POD_NAME',SOURCE_PORT=3306,SOURCE_USER='root',SOURCE_PASSWORD='$MYSQL_ROOT_PASSWORD',SOURCE_AUTO_POSITION=1,SOURCE_CONNECT_RETRY=10;START REPLICA;"
    else
      echo "primary instance skip create a replication relationship."
      exit 0 
    fi