---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql8.0-config-template
  labels:
    {{- include "apecloud-mysql.labels" . | nindent 4 }}
data:
  my.cnf: |-
    {{- .Files.Get "config/mysql8-config.tpl" | nindent 4 }}
...

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-reload-script
  labels:
    {{- include "apecloud-mysql.labels" . | nindent 4 }}
data:
  reload.tpl: |-
    {{- .Files.Get "scripts/mysql-reload.tpl" | nindent 4 }}
  reload.yaml: |-
    scripts: reload.tpl
    fileRegex: my.cnf
    formatterConfig:
      format: ini
      iniConfig:
        sectionName: mysqld
...

# configuration for agamotto log-sidecar
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: agamotto-log-sidecar-config
  labels:
    {{- include "apecloud-mysql.labels" . | nindent 4 }}
data:
  config.yaml: |-
    receivers:
      filelog/error:
        include: [/data/mysql/log/mysqld-error.log]
        include_file_name: false
        start_at: beginning
      filelog/slow:
        include: [/data/mysql/log/mysqld-slowquery.log]
        include_file_name: false
        start_at: beginning
    exporters:
      apecloudfile/error:
        path: /var/log/kubeblocks/${env:KB_NAMESPACE}_${env:DB_TYPE}_${env:KB_CLUSTER_NAME}/${env:KB_POD_NAME}/error.log
        format: raw
        rotation:
          max_megabytes: 10
          max_days: 3
          max_backups: 3
          localtime: true
      apecloudfile/slow:
        path: /var/log/kubeblocks/${env:KB_NAMESPACE}_${env:DB_TYPE}_${env:KB_CLUSTER_NAME}/${env:KB_POD_NAME}/slow.log
        format: raw
        rotation:
          max_megabytes: 10
          max_days: 3
          max_backups: 3
          localtime: true
    extensions:
      health_check:
    service:
      extensions: [health_check]
      pipelines:
        logs/error:
          receivers: [filelog/error]
          exporters: [apecloudfile/error]
        logs/slow:
          receivers: [filelog/slow]
          exporters: [apecloudfile/slow]
...
