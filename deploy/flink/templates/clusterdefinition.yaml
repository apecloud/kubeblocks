apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: flink
  labels:
    {{- include "flink.labels" . | nindent 4 }}
spec:
  type: flink
  componentDefs:
    - name: jobmanager
      characterType: flink
      workloadType: Stateless
      service:
        ports:
          - name: tcp-rpc
            port: 6123
            targetPort: tcp-rpc
          - name: tcp-http
            port: 8081
            targetPort: tcp-http
          - name: tcp-blob
            port: 6124
            targetPort: tcp-blob
      configSpecs:
        - name: flink-config
          templateRef: flink-jm-config
          volumeName: flink-config
          namespace: {{ .Release.Namespace }}
          defaultMode: 0644
      podSpec:
        {{- with .Values.jobmanager }}
        securityContext:
          {{- toYaml .podSecurityContext | nindent 10 }}
        {{- end }}
        containers:
          - name: jobmanager-main-container
            volumeMounts:
              - mountPath: /opt/flink/conf
                name: flink-config
            command:
              - /docker-entrypoint.sh
            args:
              - jobmanager
            ports:
              - containerPort: 8081
                name: tcp-http
                protocol: TCP
              - containerPort: 6123
                name: tcp-rpc
                protocol: TCP
              - containerPort: 6124
                name: tcp-blob
                protocol: TCP
            {{- with .Values.jobmanager }}
            securityContext:
              {{- toYaml .containerSecurityContext | nindent 14 }}
            {{- end }}
    - name: taskmanager
      characterType: flink
      workloadType: Stateless
      configSpecs:
        - name: flink-config
          templateRef: flink-tm-config
          volumeName: flink-config
          namespace: {{ .Release.Namespace }}
      podSpec:
        {{- with .Values.taskmanager }}
        securityContext:
          {{- toYaml .podSecurityContext | nindent 10 }}
        {{- end }}
        containers:
          - name: taskmanager-main-container
            command:
              - /docker-entrypoint.sh
            args:
              - taskmanager
            volumeMounts:
              - mountPath: /opt/flink/conf
                name: flink-config
            ports:
              - name: data
                containerPort: 6121
              - name: rpc
                containerPort: 6122
                protocol: TCP
            {{- with .Values.taskmanager }}
            securityContext:
              {{- toYaml .containerSecurityContext | nindent 14 }}
            {{- end }}