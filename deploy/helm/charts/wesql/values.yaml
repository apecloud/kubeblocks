# Default values for wesqlapp.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  registry: 
  repository: docker.io/infracreate/wesql-server-8.0
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: 0.1-SNAPSHOT

## MySQL Cluster parameters
cluster:
  ## CLUSTER_ID
  clusterId: "1"
  ## CLUSTER_START_INDEX
  clusterStartIndex: "1"
  ## @param cluster.replicaSetCount
  replicaSetCount: 3
  ## MYSQL_TEMPLATE_CONFIG
  templateConfig:
  ## MYSQL_CUSTOM_CONFIG
  customConfig:
  ## MYSQL_DYNAMIC_CONFIG
  dynamicConfig:

## MySQL Authentication parameters
auth:
  ## MYSQL_ROOT_HOST
  rootHost: "%"
  ## MYSQL_ROOT_USER
  rootUser: "root"
  ## @param auth.rootPassword Password for the `root` user. Ignored if existing secret is provided
  ##  MYSQL_ROOT_PASSWORD if null then MYSQL_ALLOW_EMPTY_PASSWORD=true
  rootPassword: ""
  ## @param auth.createDatabase Wheter to create the .Values.auth.database or not
  ##
  createDatabase: true
  ## @param auth.database Name for a custom database to create
  ## MYSQL_DATABASE
  database: "mydb"
  ## @param auth.username Name for a custom user to create
  ## MYSQL_USER
  username: "u1"
  ## MYSQL_PASSWORD
  password: "u1"
  ## @param auth.replicationUser MySQL replication user
  ##
  replicationUser: "replicator"
  ## @param auth.replicationPassword MySQL replication user password. Ignored if existing secret is provided
  ##
  replicationPassword: ""


configTemplate:
  ## @param config template name
  ## name: mysql-3node-tpl-8.0

  ## @param config template context
  configuration: |-
    [mysqld]
    # aliyun buffer pool: https://help.aliyun.com/document_detail/162326.html?utm_content=g_1000230851&spm=5176.20966629.toubu.3.f2991ddcpxxvD1#title-rey-j7j-4dt
    
    {{- $log_root := getVolumePathByName ( index .PodSpec.Containers 0 ) "log" }}
    {{- $data_root := getVolumePathByName ( index .PodSpec.Containers 0 ) "data" }}
    {{- $mysql_port_info := getPortByName ( index .PodSpec.Containers 0 ) "mysql" }}
    {{- $pool_buffer_size := ( callBufferSizeByResource ( index .PodSpec.Containers 0 ) ) }}


    {{- if $pool_buffer_size }}
    innodb-buffer-pool-size={{ $pool_buffer_size }}
    {{- end }}
    
    # require port
    {{- $mysql_port := 3306 }}
    {{- if $mysql_port_info }}
    {{- $mysql_port = $mysql_port_info.ContainerPort }}
    {{- end }}

    log-bin=master-bin
    gtid_mode=OFF
    consensus_auto_leader_transfer=ON
 
    port={{ $mysql_port }}
    
    datadir={{ $data_root }}/data
    {{ if $log_root }}
    # Mysql error log
    log-error={{ $log_root }}/mysqld.err
    # SQL access log
    general_log=1
    general_log_file={{ $log_root }}/mysqld.log
    {{- end }}
 
    pid-file=/var/run/mysqld/mysqld.pid
    socket=/var/run/mysqld/mysqld.sock
 
    [client]
    port={{ $mysql_port }}
    socket=/var/run/mysqld/mysqld.sock
    

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""
appVersionOverride: ""

monitor:
  image:
    repository: "prom/mysqld-exporter"
    tag: "v0.14.0"
    pullPolicy: "IfNotPresent"

  name: mysql-exporter
  internalPort: 9104

  config: { }
    # Allow to set specifc options on the exporter
  # logLevel: info
  # logFormat: "logger:stderr"

  collectors: { }
    # auto_increment.columns: false
    # binlog_size: false
    # engine_innodb_status: false
    # engine_tokudb_status: false
    # global_status: true
    # global_variables: true
    # info_schema.clientstats: false
    # info_schema.innodb_metrics: false
    # info_schema.innodb_tablespaces: false
    # info_schema.innodb_cmp: false
    # info_schema.innodb_cmpmem: false
    # info_schema.processlist: false
    # info_schema.processlist.min_time: 0
    # info_schema.query_response_time: false
    # info_schema.tables: true
    # info_schema.tables.databases: '*'
    # info_schema.tablestats: false
    # info_schema.schemastats: false
    # info_schema.userstats: false
    # perf_schema.eventsstatements: false
    # perf_schema.eventsstatements.digest_text_limit: 120
    # perf_schema.eventsstatements.limit: false
    # perf_schema.eventsstatements.timelimit: 86400
    # perf_schema.eventswaits: false
    # perf_schema.file_events: false
    # perf_schema.file_instances: false
    # perf_schema.indexiowaits: false
    # perf_schema.tableiowaits: false
    # perf_schema.tablelocks: false
    # perf_schema.replication_group_member_stats: false
    # slave_status: true
    # slave_hosts: false
    # heartbeat: false
    # heartbeat.database: heartbeat
    # heartbeat.table: heartbeat
