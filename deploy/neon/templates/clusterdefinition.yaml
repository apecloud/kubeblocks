apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: neon
  labels:
    {{- include "neon.labels" . | nindent 4 }}
spec:
  componentDefs:
    - name: neon-storagebroker
      workloadType: Stateful
      characterType: storagebroker
      podSpec:
        containers:
          - name: neon-storagebroker
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /usr/local/neon/storagebroker
                name: neon-storagebroker
            command:
              - "storage_broker"
              - "-l"
              - "0.0.0.0:50051"
    - name: neon-safekeeper
      workloadType: Stateful
      characterType: safekeeper
      componentDefRef:
        - &storagebrokerRef
          componentDefName: neon-storagebroker
          componentRefEnv:
            - name: NEON_BROKER_SVC
              valueFrom:
                type: HeadlessServiceRef
                format: $(POD_FQDN){{ .Values.clusterDomain }}
                joinWith: ","
      podSpec:
        containers:
          - name: neon-safekeeper
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /usr/local/neon/safekeeper
                name: neon-safekeeper
            env:
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    fieldPath: status.podIP
            command:
              - /bin/bash
              - -c
              - |
                set -ex
                trap : TERM INT
                exec safekeeper --id=1 -D /data --broker-endpoint=http://$NEON_BROKER_SVC:50051 -l ${POD_IP}:5454 --listen-http=0.0.0.0:7676
    - name: neon-pageserver
      workloadType: Stateful
      characterType: pageserver
      componentDefRef:
        - *storagebrokerRef
      podSpec:
        containers:
          - name: neon-pageserver
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /usr/local/neon/pageserver
                name: neon-pageserver
            command:
              - /bin/bash
              - -c
              - |
                set -ex
                trap : TERM INT
                exec pageserver -D /data -c "id=1" -c "broker_endpoint='http://$NEON_BROKER_SVC:50051'" -c "listen_pg_addr='0.0.0.0:6400'" -c "listen_http_addr='0.0.0.0:9898'" -c "pg_distrib_dir='/opt/neondatabase-neon/pg_install'"
    - name: neon-compute
      scriptSpecs:
        - name: neon-compute-scripts
          templateRef: neon-compute-scripts
          namespace: {{ .Release.Namespace }}
          volumeName: scripts
          defaultMode: 493
      workloadType: Stateful
      characterType: compute
      componentDefRef:
        - componentDefName: neon-safekeeper
          componentRefEnv:
            - name: NEON_SAFEKEEPER_SVC
              valueFrom:
                type: HeadlessServiceRef
                format: $(POD_FQDN){{ .Values.clusterDomain }}
                joinWith: ","
        - componentDefName: neon-pageserver
          componentRefEnv:
            - name: NEON_PAGESERVER_SVC
              valueFrom:
                type: HeadlessServiceRef
                format: $(POD_FQDN){{ .Values.clusterDomain }}
                joinWith: ","
      podSpec:
        containers:
          - name: neon-compute
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /usr/local/neon/compute
                name: neon-compute
              - mountPath: /scripts
                name: scripts
            command:
              - /bin/bash
              - -c
              - |
                set -ex
                trap : TERM INT
                export PAGESERVER="${NEON_PAGESERVER_SVC}"
                export SAFEKEEPERS="${NEON_SAFEKEEPER_SVC}:5454"
                exec /compute.sh
            ports:
              - containerPort: 55432
                name: http
                protocol: TCP
