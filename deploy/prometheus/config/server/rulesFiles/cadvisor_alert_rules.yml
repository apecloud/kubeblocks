## Sample prometheus rules/alerts
## NOTE: Please review these carefully as thresholds and behavior may not meet
##       your SLOs or labels.
##

groups:
  - name: GoogleCadvisor
    rules:
      - alert: ContainerKilled
        expr: 'time() - container_last_seen{container!="",container!="POD"} > 60'
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: 'Container has disappeared more than 60 seconds'
          description: 'Container has disappeared {{ $value | printf "%.1f" }} seconds. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'

      - alert: ContainerCpuUsageWarning
        expr: 'sum(rate(container_cpu_usage_seconds_total{container!="",container!="POD"}[2m])) BY (instance,pod,container) * 100 > 70'
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Container CPU usage is high (> 70%)'
          description: 'Container CPU usage is {{ $value | printf "%.2f" }} percent. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'

      - alert: ContainerCpuUsageCritical
        expr: 'sum(rate(container_cpu_usage_seconds_total{container!="",container!="POD"}[2m])) BY (instance,pod,container) * 100 > 90'
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Container CPU usage is very high (> 90%)'
          description: 'Container CPU usage is {{ $value | printf "%.2f" }} percent. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'

      - alert: ContainerMemoryUsage
        expr: 'sum(container_memory_working_set_bytes{container!="",container!="POD"}) BY (instance,pod,container) / sum(container_spec_memory_limit_bytes{container!="",container!="POD"} > 0) BY (instance,pod,container) * 100 > 90'
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Container Memory usage is high (> 90%)'
          description: 'Container Memory usage is {{ $value | printf "%.2f" }} percent. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'

      - alert: ContainerMemoryUsagePredict
        expr: 'sum(predict_linear(container_memory_working_set_bytes{container!="",container!="POD"}[15m], 30*60)) BY (instance,pod,container) - sum(container_spec_memory_limit_bytes{container!="",container!="POD"} > 0) BY (instance,pod,container) >= 0'
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Container Memory predict usage may exceed the limit 30 minutes later'
          description: 'Container Memory predict usage may exceed the limit 30 minutes later, the predict value is {{ $value | humanize1024 }}. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'

      - alert: ContainerVolumeUsage
        expr: 'sum(container_fs_usage_bytes) BY (instance,device) / sum(container_fs_limit_bytes) BY (instance,device) * 100 > 90'
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Device Volume usage is high (> 90%)'
          description: 'Device Volume usage is {{ $value | printf "%.2f" }} percent. (device: {{ $labels.device }})'

      - alert: ContainerHighCpuThrottleRate
        expr: 'rate(container_cpu_cfs_throttled_seconds_total{container!="",container!="POD"}[2m]) > 1'
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: 'Container high throttle rate (> 1)'
          description: 'Container is being throttled and the value is {{ $value | printf "%.2f" }}. (pod: {{ $labels.pod }}, container: {{ $labels.container }})'
