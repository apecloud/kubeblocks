apiVersion: apps.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: prometheus
  labels:
    {{- include "prometheus.labels" . | nindent 4 }}
spec:
  type: prometheus
  componentDefs:
    # kind: Deployment
    - name: prometheus-server
      workloadType: Stateful
      service:
        ports:
          - name: http
            port: 80
            protocol: TCP
            targetPort: 9090
      volumeTypes:
        - name: data
          type: data
      configSpecs:
        - name: server-configuration
          templateRef: prometheus-server
          namespace: {{ .Release.Namespace }}
          volumeName: config-volume
          defaultMode: 0777
      podSpec:
        securityContext:
          runAsUser: 0
        enableServiceLinks: true
        containers:
          - name: prometheus-server-configmap-reload
            securityContext:
              runAsUser: 0
            env:
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: status.podIP
            args:
              - --volume-dir=/etc/config
              - --webhook-url=http://127.0.0.1:9090/-/reload
            volumeMounts:
              - name: config-volume
                mountPath: /etc/config
                readOnly: true

          - name: prometheus-server
            securityContext:
              runAsUser: 0
            args:
            {{- if .Values.server.defaultFlagsOverride }}
              {{ toYaml .Values.server.defaultFlagsOverride }}
            {{- else }}
              {{- if .Values.server.prefixURL }}
                - --web.route-prefix={{ .Values.server.prefixURL }}
              {{- end }}
              {{- if .Values.server.retention }}
                - --storage.tsdb.retention.time={{ .Values.server.retention }}
              {{- end }}
                - --config.file={{ .Values.server.configPath }}
              {{- if .Values.server.storagePath }}
                - --storage.tsdb.path={{ .Values.server.storagePath }}
              {{- else }}
                - --storage.tsdb.path={{ .Values.server.persistentVolume.mdountPath }}
              {{- end }}
                - --web.console.libraries=/etc/prometheus/console_libraries
                - --web.console.templates=/etc/prometheus/consoles
              {{- range .Values.server.extraFlags }}
                - --{{ . }}
              {{- end }}
              {{- range $key, $value := .Values.server.extraArgs }}
                - --{{ $key }}={{ $value }}
              {{- end }}
              {{- if .Values.server.baseURL }}
                - --web.external-url={{ .Values.server.baseURL }}
              {{- end }}
            {{- end }}
            readinessProbe:
              httpGet:
                path: /-/ready
                port: 9090
                scheme: HTTP
              initialDelaySeconds: 30
              periodSeconds: 5
              timeoutSeconds: 4
              failureThreshold: 3
              successThreshold: 1
            livenessProbe:
              httpGet:
                path: /-/healthy
                port: 9090
                scheme: HTTP
              initialDelaySeconds: 30
              periodSeconds: 15
              timeoutSeconds: 10
              failureThreshold: 3
              successThreshold: 1
            volumeMounts:
              - name: config-volume
                mountPath: /etc/config
              - name: rule-volume
                mountPath: /etc/config-rule
              - name: data
                mountPath: /data
                subPath: ""
            ports:
              - containerPort: 9090
                name: server
        dnsPolicy: ClusterFirst
        terminationGracePeriodSeconds: 300
        volumes:
          - name: config-volume
            configMap:
              name: prometheus-server
          - name: rule-volume
            configMap:
              name: prometheus-rule

    - name: alertmanager
      workloadType: Stateful # Consensus
      characterType: prometheus
      configSpecs:
        - name: alertmanager-configuration
          templateRef: prometheus-alertmanager
          namespace: {{ .Release.Namespace }}
          volumeName: config-volume
          defaultMode: 0777
      volumeTypes:
        - name: alert
          type: data
      service:
        ports:
          - name: http
            port: 80
            protocol: TCP
            targetPort: 9093
      podSpec:
        securityContext:
          runAsUser: 0
        containers:
          - name: prometheus-alertmanager
            env:
              - name: POD_IP
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: status.podIP
            args:
              - --config.file=/etc/config/alertmanager.yml
              - --storage.path={{ .Values.alertmanager.persistentVolume.mountPath }}
              {{- if .Values.alertmanager.statefulSet.headless.enableMeshPeer }}
                - --cluster.advertise-address=[$(POD_IP)]:6783
                - --cluster.listen-address=0.0.0.0:6783
              {{- else }}
                - --cluster.listen-address=
              {{- end }}
              {{- range $key, $value := .Values.alertmanager.extraArgs }}
                - --{{ $key }}={{ $value }}
              {{- end }}
              {{- if .Values.alertmanager.baseURL }}
                - --web.external-url={{ .Values.alertmanager.baseURL }}
              {{- end }}
            readinessProbe:
              httpGet:
                path: /-/ready
                port: 9093
              initialDelaySeconds: 30
              timeoutSeconds: 30
            ports:
              - containerPort: 9093
                name: alertmanager
            volumeMounts:
              - name: config-volume
                mountPath: /etc/config
              - name: data
                mountPath: "/data"
                subPath: ""

          - name: prometheus-alertmanager-configmap-reload
            args:
              - --volume-dir=/etc/config
              - --webhook-url=http://127.0.0.1:9093/-/reload
            readinessProbe:
              httpGet:
                path: /-/ready
                port: 9093
              initialDelaySeconds: 30
              timeoutSeconds: 30
            volumeMounts:
              - name: config-volume
                mountPath: /etc/config
                readOnly: true
        volumes:
          - name: config-volume
            configMap:
              name: prometheus-alertmanager