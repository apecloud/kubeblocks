---
{{- if (empty .Values.alertmanager.configMapOverrideName) }}
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    component: "alertmanager"
    {{- include "prometheus.labels" . | nindent 4 }}
  name: {{ template "prometheus.alertmanager.fullname" . }}-config
data:
{{- range $path, $content := .Files.Glob "config/alertmanager/*.yml" }}
  {{ trimPrefix "config/alertmanager/" $path }}: |-
  {{- $content | toString | nindent 4 }}
{{- end }}
{{- end }}


---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    component: "server"
    {{- include "prometheus.labels" . | nindent 4 }}
  name: {{ template "prometheus.server.fullname" . }}-rule
data:
{{- range $path, $content := .Files.Glob "config/server/rulesFiles/*" }}
  {{ trimPrefix "config/server/rulesFiles/" $path }}: |-
  {{- $content | toString | nindent 4 }}
{{- end }}


---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    component: "server"
    {{- include "prometheus.labels" . | nindent 4 }}
  name: {{ template "prometheus.server.fullname" . }}-config
data:
{{- $values := .Values }}
{{- $root := . -}}
{{- range $path, $content := .Files.Glob "config/server/serverFiles/*" }}
  {{- if eq $path "config/server/serverFiles/prometheus.yml" -}}
  {{ trimPrefix "config/server/serverFiles/" $path | nindent 2 }}: |-
    global:
    {{- with $values.server.global }}
      scrape_interval: {{ .scrape_interval }}
      scrape_timeout: {{ .scrape_timeout }}
      evaluation_interval: {{ .evaluation_interval }}
    {{- end }}
    {{- if $values.server.remoteWrite }}
    remote_write:
      {{- $values.server.remoteWrite | toYaml | nindent 8 }}
    {{- end }}
    alerting:
      alertmanagers:
      - kubernetes_sd_configs:
          - role: pod
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - source_labels: [ __meta_kubernetes_namespace ]
            regex: {{ $root.Release.Namespace }}
            action: keep
          - source_labels: [ __meta_kubernetes_pod_label_app_kubernetes_io_instance ]
            regex: .*prometheus-playground
            action: keep
          - source_labels: [ __meta_kubernetes_pod_label_apps_kubeblocks_io_component_name ]
            regex: alertmanager
            action: keep
          - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_probe ]
            regex: .*
            action: keep
          - source_labels: [ __meta_kubernetes_pod_container_port_number ]
            regex: "9093"
            action: keep
    {{- $content | toString | nindent 4 }}
  {{- else }}
  {{ trimPrefix "config/server/serverFiles/" $path | nindent 2 }}: |-
    {{- $content | toString | nindent 4 }}
  {{- end }}
{{- end }}

