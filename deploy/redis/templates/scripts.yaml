apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-scripts
  labels:
    {{- include "redis.labels" . | nindent 4 }}
data:
  setup.sh: |
    #!/bin/sh
    set -ex
    # set default user password and replication user password
    until redis-cli -h 127.0.0.1 -p 6379 ping; do sleep 1; done
    redis-cli -h 127.0.0.1 -p 6379 ACL SETUSER default ON \>$REDIS_DEFAULT_PASSWORD allcommands allkeys
    KB_PRIMARY_POD_NAME_PREFIX=${KB_PRIMARY_POD_NAME%%\.*}
    if [ "$KB_PRIMARY_POD_NAME_PREFIX" = "$KB_POD_NAME" ]; then
      echo "primary instance skip create a replication relationship."
      exit 0
    else
      until redis-cli -h $KB_PRIMARY_POD_NAME -p 6379 ping; do sleep 1; done
      redis-cli -h 127.0.0.1 -p 6379 -a $REDIS_DEFAULT_PASSWORD replicaof $KB_PRIMARY_POD_NAME 6379 || exit 1
    fi
  redis-start.sh: |
    {{- .Files.Get "scripts/redis7-start.sh.tpl" | nindent 4 }}
  redis-sentinel-setup.sh: |-
    {{- .Files.Get "scripts/redis-sentinel-setup.sh.tpl" | nindent 4 }}
  redis-sentinel-start.sh: |-
    {{- .Files.Get "scripts/redis-sentinel-start.sh.tpl" | nindent 4 }}
  redis-sentinel-post-start.sh: |-
    #!/bin/sh
    set -ex
    # set default user password and replication user password
    until redis-cli -h 127.0.0.1 -p 26379 ping; do sleep 1; done
    redis-cli -h 127.0.0.1 -p 26379 ACL SETUSER $SENTINEL_USER ON \>$SENTINEL_PASSWORD allchannels +@all
  redis-sentinel-ping.sh: |-
    #!/bin/sh
    set -ex
    response=$(
          timeout -s 3 $1 \
          redis-cli \
            -h localhost \
            -p 26379 \
            -a $SENTINEL_PASSWORD \
            ping
        )
    if [ "$?" -eq "124" ]; then
      echo "Timed out"
      exit 1
    fi
    if [ "$response" != "PONG" ]; then
      echo "$response"
      exit 1
    fi