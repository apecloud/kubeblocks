apiVersion: dataprotection.kubeblocks.io/v1alpha1
kind: BackupTool
metadata:
  name: xtrabackup-mysql
spec:
  image: percona/percona-xtrabackup
  databaseEngine: mysql
  deployKind: job
  resources:
    limits:
      cpu: "1"
      memory: 2Gi
    requests:
      cpu: 100m
      memory: 128Mi
  env:
    - name: DATA_DIR
      value: /data/mysql/data
  physical:
    restoreCommands:
      - >
        set -e;
        [[ ${DATA_DIR} == "" ]] && (echo "Empty string for env DATA_DIR, exiting restore"; exit 0);
        mkdir -p ${DATA_DIR} && cd ${DATA_DIR};
        rm -rf ${DATA_DIR}/*;
        xbstream -x < /${BACKUP_DIR}/${BACKUP_NAME}.xbstream;
        xtrabackup --decompress  --target-dir=${DATA_DIR};
        find . -name "*.qp"|xargs rm -f;
        touch ${DATA_DIR}/.xtrabackup_restore_new_cluster;
        xtrabackup --prepare --target-dir=${DATA_DIR};
        chmod -R 0777 ${DATA_DIR};
    incrementalRestoreCommands: []
  logical:
    restoreCommands: []
    incrementalRestoreCommands: []
  backupCommands:
    - |
      mkdir -p ${BACKUP_DIR};
      xtrabackup --compress --backup  --safe-slave-backup --slave-info --stream=xbstream \
      --host=${DB_HOST} --user=${DB_USER} --datadir=${DATA_DIR} \
      > /${BACKUP_DIR}/${BACKUP_NAME}.xbstream
  incrementalBackupCommands: []