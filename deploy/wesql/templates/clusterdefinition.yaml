apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: apecloud-wesql
  labels:
    {{- include "wesqlapp.labels" . | nindent 4 }}
spec:
  type: state.mysql
  connectionCredential:
    username: root
    password: "$(RANDOM_PASSWD)"
  components:
    - typeName: replicasets
      characterType: mysql
      probes:
        roleChangedProbe:
          failureThreshold: {{ .Values.roleChangedProbe.failureThreshold }}
          periodSeconds: {{ .Values.roleChangedProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.roleChangedProbe.timeoutSeconds }}
      monitor:
        builtIn: true
      logConfigs:
        {{- range $name,$pattern := .Values.logConfigs }}
        - name: {{ $name }}
          filePathPattern: {{ $pattern }}
        {{- end }}
      configTemplateRefs:
        - name: mysql-3node-tpl-8.0
          namespace: {{ .Release.Namespace }}
          volumeName: mysql-config
        - name: wesql-scripts
          namespace: {{ .Release.Namespace }}
          volumeName: scripts
          defaultMode: 493
      defaultReplicas: 3
      componentType: Consensus
      consensusSpec:
        leader:
          name: leader
          accessMode: ReadWrite
        followers:
          - name: follower
            accessMode: Readonly
      service:
        ports:
          - protocol: TCP
            port: 3306
            targetPort: mysql
      horizontalScalePolicy:
        type: Snapshot
        backupTemplateSelector:
          "clusterdefinition.kubeblocks.io/name": apecloud-wesql
      podSpec:
        containers:
          - name: mysql
            imagePullPolicy: IfNotPresent
            volumeMounts:
              - mountPath: /data/mysql
                name: data
              - mountPath: /opt/mysql
                name: mysql-config
              - name: scripts
                mountPath: /scripts
            ports:
              - containerPort: 3306
                name: mysql
              - containerPort: 13306
                name: paxos
            env:
              - name: MYSQL_ROOT_HOST
                value: {{ .Values.auth.rootHost | default "%" | quote }}
              - name: MYSQL_ROOT_USER
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: username
              - name: MYSQL_ROOT_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
              - name: MYSQL_DATABASE
                value: {{- if .Values.auth.createDatabase }} {{ .Values.auth.database | quote }}  {{- else }} "" {{- end }}
              - name: MYSQL_USER
                value: {{ .Values.auth.username | default "" | quote }}
              - name: MYSQL_PASSWORD
                value: {{ .Values.auth.password | default "" | quote }}
              - name: CLUSTER_ID
                value: {{ .Values.cluster.clusterId | default "1" | quote }}
              - name: CLUSTER_START_INDEX
                value: {{ .Values.cluster.clusterStartIndex | default "1" | quote }}
              - name: REPLICATIONUSER
                value: {{ .Values.auth.replicationUser | default "replicator" | quote }}
              - name: REPLICATION_PASSWORD
                value: {{ .Values.auth.replicationPassword | default "" | quote }}
              - name: MYSQL_TEMPLATE_CONFIG
                value: {{ if .Values.cluster.templateConfig }}{{ .Values.cluster.templateConfig }}{{ end }}
              - name: MYSQL_CUSTOM_CONFIG
                value: {{ if .Values.cluster.customConfig }}{{ .Values.cluster.customConfig }}{{ end }}
              - name: MYSQL_DYNAMIC_CONFIG
                value: {{ if .Values.cluster.dynamicConfig }}{{ .Values.cluster.dynamicConfig }}{{ end }}
            command: ["/scripts/setup.sh"]
