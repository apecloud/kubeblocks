# Default values for wesqlapp.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  registry: 
  repository: docker.io/apecloud/wesql-server
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: 8.0.30-4.alpha4.20221117.gba56235

## MySQL Cluster parameters
cluster:
  ## CLUSTER_ID
  clusterId: "1"
  ## CLUSTER_START_INDEX
  clusterStartIndex: "1"
  ## @param cluster.replicaSetCount
  replicaSetCount: 3
  ## MYSQL_TEMPLATE_CONFIG
  templateConfig:
  ## MYSQL_CUSTOM_CONFIG
  customConfig:
  ## MYSQL_DYNAMIC_CONFIG
  dynamicConfig:

## MySQL Authentication parameters
auth:
  ## MYSQL_ROOT_HOST
  rootHost: "%"
  ## @param auth.createDatabase Wheter to create the .Values.auth.database or not
  ##
  createDatabase: true
  ## @param auth.database Name for a custom database to create
  ## MYSQL_DATABASE
  database: "mydb"
  ## @param auth.username Name for a custom user to create
  ## MYSQL_USER
  username: "u1"
  ## MYSQL_PASSWORD
  password: "u1"
  ## @param auth.replicationUser MySQL replication user
  ##
  replicationUser: "replicator"
  ## @param auth.replicationPassword MySQL replication user password. Ignored if existing secret is provided
  ##
  replicationPassword: ""


configTemplate:
  ## @param config template name
  ## name: mysql-3node-tpl-8.0

  ## @param config template context
  configuration: |-
    [mysqld]
    # aliyun buffer pool: https://help.aliyun.com/document_detail/162326.html?utm_content=g_1000230851&spm=5176.20966629.toubu.3.f2991ddcpxxvD1#title-rey-j7j-4dt
    
    {{- $log_root := getVolumePathByName ( index $.podSpec.containers 0 ) "log" }}
    {{- $data_root := getVolumePathByName ( index $.podSpec.containers 0 ) "data" }}
    {{- $mysql_port_info := getPortByName ( index $.podSpec.containers 0 ) "mysql" }}
    {{- $pool_buffer_size := ( callBufferSizeByResource ( index $.podSpec.containers 0 ) ) }}
    
    {{- if $pool_buffer_size }}
    innodb-buffer-pool-size={{ $pool_buffer_size }}
    {{- end }}
    
    # require port
    {{- $mysql_port := 3306 }}
    {{- if $mysql_port_info }}
    {{- $mysql_port = $mysql_port_info.containerPort }}
    {{- end }}

    log-bin=master-bin
    gtid_mode=OFF
    consensus_auto_leader_transfer=ON
 
    port={{ $mysql_port }}
    
    datadir={{ $data_root }}/data
    
    {{- if hasKey $.component "enabledLogs" }}
    {{- if mustHas "error" $.component.enabledLogs }}
    # Mysql error log
    log_error={{ $data_root }}/log/mysqld.err
    {{- end }}
    
    {{- if mustHas "slow" $.component.enabledLogs }}
    # MySQL Slow log
    slow_query_log=ON
    long_query_time=5
    log_output=FILE
    slow_query_log_file={{ $data_root }}/log/mysqld-slow.log
    {{- end }}
    {{- end }}
    
    {{- if $log_root }}
    # SQL access log, default off 
    general_log=OFF
    general_log_file={{ $log_root }}/mysqld-audit.log
    {{- end }}
    
    
    pid-file=/var/run/mysqld/mysqld.pid
    socket=/var/run/mysqld/mysqld.sock
 
    [client]
    port={{ $mysql_port }}
    socket=/var/run/mysqld/mysqld.sock
    

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""
clusterVersionOverride: ""

logConfigs:
  error: /data/mysql/log/mysqld.err
  slow: /data/mysql/log/*slow.log

roleChangedProbe:
  failureThreshold: 2
  periodSeconds: 1
  timeoutSeconds: 1
