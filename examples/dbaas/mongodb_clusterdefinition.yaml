apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: mongodb-cluster-definition
spec:
  type: mongodb
  components:
    - typeName: mongos
      maxAvailable: 16
      minAvailable: 0
      defaultReplicas: 1
      componentType: Stateless
      podSpec:
        containers:
          - name: mongos
            image: mongo:5.0.14
            command:
              - bin/sh
              - -c
              - |
                mongos --config /etc/mongodb/config.yaml
    - typeName: config_server
      maxAvailable: 1
      minAvailable: 1
      defaultReplicas: 3
      componentType: Consensus
      consensusSpec:
        leader:
          name: "primary"
          accessMode: ReadWrite
        followers:
          - name: "secondary"
            accessMode: ReadWrite
        updateStrategy: Serial
      podSpec:
        containers:
          - name: config_server
            image: mongo:5.0.14
            env:
              - name: POD_NAME
                valueFrom:
                  fieldPathRef:
                    fieldPath: metadata.name
            command:
              - bin/sh
              - -c
              - |
                RPL_SET_NAME=$(echo $POD_NAME | grep -o ".*-");
                RPL_SET_NAME=${RPL_SET_NAME%-};
                mongod --configsvr --replSet $RPL_SET_NAME
        lifecycle:
          postStart:
            exec:
              command:
                - bin/sh
                - -c
                - |
                  INDEX=$(echo $POD_NAME | grep -o "-[0-9]\+");
                  INDEX=${INDEX#-};
                  if [ $INDEX -ne 0 ]; then exit 0; fi
                  
                  until mongosh --eval "rs.status().ok"; do sleep 1; done
                  
                  status=$(mongosh --eval "rs.status().ok")
                  if [ $status -ne 0 ]; then exit 0; fi
                  
                  RPL_SET_NAME=$(echo $POD_NAME | grep -o ".*-");
                  RPL_SET_NAME=${RPL_SET_NAME%-};
                  
                  MEMBERS=""
                  i=0
                  while [ $i -lt $KB_CONFIG_SERVER_N ]; do
                  if [ $i -ne 0 ]; then
                  MEMBERS="$MEMBERS,";
                  fi;
                  host=$(eval echo \$KB_CONFIG_SERVER_"$i"_HOSTNAME)
                  MEMBERS="$MEMBERS{_id: $i, host: \"$host\"}"
                  i=$(( i + 1))
                  done
                  mongosh --eval "rs.initiate({_id: \"$RPL_SET_NAME\", configsvr: true, members: [$MEMBERS]})"
    - typeName: shard
      maxAvailable: 16
      minAvailable: 0
      defaultReplicas: 3
      componentType: Consensus
      consensusSpec:
        leader:
          name: "primary"
          accessMode: ReadWrite
        followers:
          - name: "secondary"
            accessMode: ReadWrite
        updateStrategy: BestEffortParallel
      podSpec:
        containers:
          - name: shard
            image: mongo:5.0.14
            env:
              - name: POD_NAME
                valueFrom:
                  fieldPathRef:
                    fieldPath: metadata.name
            command:
              - bin/sh
              - -c
              - |
                RPL_SET_NAME=$(echo $POD_NAME | grep -o ".*-");
                RPL_SET_NAME=${RPL_SET_NAME%-};
                mongod --shardsvr --replSet $RPL_SET_NAME