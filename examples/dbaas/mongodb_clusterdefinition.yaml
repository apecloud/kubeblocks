apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: mongodb-cluster-definition
spec:
  type: state.mongodb
  components:
    - typeName: mongos
      maxAvailable: 16
      minAvailable: 1
      defaultReplicas: 1
      componentType: Stateless
      podSpec:
        containers:
          - name: mongos
            image: mongo:5.0.14
            command:
              - bin/sh
              - -c
              - |
                mongos --config /etc/mongodb/config.yaml
    - typeName: config-server
      maxAvailable: 1
      minAvailable: 1
      defaultReplicas: 3
      componentType: Consensus
      consensusSpec:
        leader:
          name: "primary"
          accessMode: ReadWrite
        followers:
          - name: "secondary"
            accessMode: ReadWrite
        updateStrategy: Serial
      podSpec:
        containers:
          - name: config-server
            image: mongo:5.0.14
            env:
              - name: POD_NAME
                valueFrom:
                  fieldPathRef:
                    fieldPath: metadata.name
            command:
              - bin/sh
              - -c
              - |
                RPL_SET_NAME=$(echo $POD_NAME | grep -o ".*-");
                RPL_SET_NAME=${RPL_SET_NAME%-};
                mongod --configsvr --replSet $RPL_SET_NAME
        lifecycle:
          postStart:
            exec:
              command:
                - bin/sh
                - -c
                - |
                  INDEX=$(echo $POD_NAME | grep -o "-[0-9]\+");
                  INDEX=${INDEX#-};
                  if [ $INDEX -eq 0 ]; then
                    status=$(mongosh --eval "rs.status().ok")
                    if [ $status -eq 0 ]; then
                      # TODO rs.initiate()
                    fi;
                  fi;
    - typeName: shard
      maxAvailable: 16
      minAvailable: 1
      defaultReplicas: 3
      componentType: Consensus
      consensusSpec:
        leader:
          name: "primary"
          accessMode: ReadWrite
        followers:
          - name: "secondary"
            accessMode: ReadWrite
        updateStrategy: BestEffortParallel
      podSpec:
        containers:
          - name: shard
            image: mongo:5.0.14
            env:
              - name: POD_NAME
                valueFrom:
                  fieldPathRef:
                    fieldPath: metadata.name
            command:
              - bin/sh
              - -c
              - |
                RPL_SET_NAME=$(echo $POD_NAME | grep -o ".*-");
                RPL_SET_NAME=${RPL_SET_NAME%-};
                mongod --shardsvr --replSet $RPL_SET_NAME