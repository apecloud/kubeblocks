apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: apecloud-redis
spec:
  type: state.redis-7
  components:
    - typeName: replication
      defaultReplicas: 2
      minReplicas: 1
      maxReplicas: 16
      componentType: Replication
      replicationSpec:
      service:
        ports:
          - protocol: TCP
            port: 6379
      configTemplateRefs:
        - name: redis-primary-config-7.0.5
          volumeName: primary
        - name: redis-secondary-config-7.0.5
          volumeName: secondary
      monitor:
        builtIn: false
        exporterConfig:
          scrapePort: 9121
          scrapePath: "/metrics"
      podSpec:
        initContainers:
          - name: redis-init-container
            image: redis:7.0.5
            command:
              - /bin/sh
              - "-c"
              - | 
                set -ex
                if [ $KB_PRIMARY_POD_NAME ]; then
                  cp /etc/conf/primary/redis.conf /etc/conf
                else
                  cp /etc/conf/secondary/redis.conf /etc/conf
                fi
            volumeMounts:
              - name: data
                mountPath: /data
              - name: conf
                mountPath: /etc/conf
              - name: primary
                mountPath: /etc/conf/primary
              - name: secondary
                mountPath: /etc/conf/secondary
        containers:
          - name: redis
            image: redis:7.0.5
            ports:
              - name: redis
                containerPort: 6379
            volumeMounts:
              - name: data
                mountPath: /data
              - name: conf
                mountPath: /etc/conf
              - name: primary
                mountPath: /etc/conf/primary
              - name: secondary
                mountPath: /etc/conf/secondary
            args: ["/etc/conf/redis.conf"]
            lifecycle:
              postStart:
                exec:
                  command:
                    - /bin/sh
                    - "-c"
                    - |
                      set -ex
                      if [ $KB_PRIMARY_POD_NAME ]; then
                        until redis-cli -h $KB_PRIMARY_POD_NAME -p $KB_PRIMARY_POD_PORT_0 ping; do sleep 1; done
                        redis-cli -h 127.0.0.1 -p 6379 replicaof $KB_PRIMARY_POD_NAME $KB_PRIMARY_POD_PORT_0 || exit 1
                      else
                        echo "primary instance skip create a replication relationship."
                        exit 0
                      fi
          - name: redis-exporter
            image: oliver006/redis_exporter:latest
            imagePullPolicy: IfNotPresent
            resources:
              requests:
                cpu: 100m
                memory: 100Mi
            ports:
              - name: metrics
                containerPort: 9121
                protocol: TCP
            livenessProbe:
              httpGet:
                path: /
                port: 9121
            readinessProbe:
              httpGet:
                path: /
                port: 9121
        volumes:
          - name: conf
            emptyDir: { }
  connectionCredential:
    user: ""
    password: ""