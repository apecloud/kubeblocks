apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: apecloud-redis
spec:
  type: state.redis-7
  components:
    - typeName: replication
      defaultReplicas: 2
      componentType: Replication
      replicationSpec:
        createReplication:
          dbEngineContainer: redis
          commands:
            - "redis-cli replicaof $(KB_PRIMARY_POD_NAME) 6379"
      service:
        ports:
          - protocol: TCP
            port: 6379
      podSpec:
        containers:
          - name: redis
            image: redis:7.0.5
            ports:
              - name: redis
                containerPort: 6379
            volumeMounts:
              - name: data
                mountPath: /data
              - name: config-map
                mountPath: /etc/conf
            args: ["/etc/conf/redis.conf"]
            lifecycle:
              postStart:
                exec:
                  command:
                    - /bin/sh
                    - "-c"
                    - |
                      set -ex
                      if [ $KB_PRIMARY_POD_NAME ]; then
                        until redis-cli -h $KB_PRIMARY_POD_NAME -p $KB_PRIMARY_POD_PORT_0 ping; do sleep 1; done
                        redis-cli -h 127.0.0.1 -p 6379 replicaof $KB_PRIMARY_POD_NAME $KB_PRIMARY_POD_PORT_0 || exit 1
                      else
                        echo "primary instance skip create a replication relationship."
                        exit 0
                      fi
        volumes:
          - name: conf
            emptyDir: { }
          - name: config-map
            configMap:
              name: redis-config-7.0.5
