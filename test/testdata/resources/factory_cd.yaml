apiVersion: dbaas.kubeblocks.io/v1alpha1
kind: ClusterDefinition
metadata:
  name: cluster-definition-factory
spec:
  type: empty
  components:
    - typeName: stateful-mysql-8.0
      characterType: mysql
      componentType: Stateful
      defaultReplicas: 1
      podSpec:
        containers:
          - name: mysql
            imagePullPolicy: IfNotPresent
            ports:
              - containerPort: 3306
                protocol: TCP
                name: mysql
              - containerPort: 13306
                protocol: TCP
                name: paxos
            volumeMounts:
              - mountPath: /var/lib/mysql
                name: data
              - mountPath: /var/log
                name: log
            env:
              - name: "MYSQL_ROOT_PASSWORD"
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
            command: ["/usr/bin/bash", "-c"]
            args:
              - >
                cluster_info="";
                for (( i=0; i<$KB_REPLICASETS_N; i++ )); do
                  if [ $i -ne 0 ]; then
                    cluster_info="$cluster_info;";
                  fi;
                  host=$(eval echo \$KB_REPLICASETS_"$i"_HOSTNAME)
                  cluster_info="$cluster_info$host:13306";
                done;
                idx=0;
                while IFS='-' read -ra ADDR; do
                  for i in "${ADDR[@]}"; do
                    idx=$i;
                  done;
                done <<< "$KB_POD_NAME";
                echo $idx;
                cluster_info="$cluster_info@$(($idx+1))";
                echo $cluster_info;
                mkdir -p /data/mysql/data;
                mkdir -p /data/mysql/log;
                chmod +777 -R /data/mysql;
                docker-entrypoint.sh mysqld --cluster-start-index=1 --cluster-info="$cluster_info" --cluster-id=1
    - typeName: stateless-nginx
      componentType: Stateless
      defaultReplicas: 1
      podSpec:
        containers:
          - name: nginx
      service:
        ports:
          - protocol: TCP
            port: 80
    - typeName: consensus-mysql
      characterType: mysql
      componentType: Consensus
      consensusSpec:
        leader:
          name: "leader"
          accessMode: ReadWrite
        followers:
          - name: "follower"
            accessMode: Readonly
        updateStrategy: BestEffortParallel
      service:
        ports:
          - protocol: TCP
            port: 3306
      probes:
        roleChangedProbe:
          failureThreshold: 3
          periodSeconds: 1
          timeoutSeconds: 5
      defaultReplicas: 1
      podSpec:
        containers:
          - name: mysql
            imagePullPolicy: IfNotPresent
            ports:
              - containerPort: 3306
                protocol: TCP
                name: mysql
              - containerPort: 13306
                protocol: TCP
                name: paxos
            volumeMounts:
              - mountPath: /var/lib/mysql
                name: data
              - mountPath: /var/log
                name: log
            env:
              - name: "MYSQL_ROOT_PASSWORD"
                valueFrom:
                  secretKeyRef:
                    name: $(CONN_CREDENTIAL_SECRET_NAME)
                    key: password
            command: ["/usr/bin/bash", "-c"]
            args:
              - >
                cluster_info="";
                for (( i=0; i<$KB_REPLICASETS_N; i++ )); do
                  if [ $i -ne 0 ]; then
                    cluster_info="$cluster_info;";
                  fi;
                  host=$(eval echo \$KB_REPLICASETS_"$i"_HOSTNAME)
                  cluster_info="$cluster_info$host:13306";
                done;
                idx=0;
                while IFS='-' read -ra ADDR; do
                  for i in "${ADDR[@]}"; do
                    idx=$i;
                  done;
                done <<< "$KB_POD_NAME";
                echo $idx;
                cluster_info="$cluster_info@$(($idx+1))";
                echo $cluster_info;
                mkdir -p /data/mysql/data;
                mkdir -p /data/mysql/log;
                chmod +777 -R /data/mysql;
                docker-entrypoint.sh mysqld --cluster-start-index=1 --cluster-info="$cluster_info" --cluster-id=1